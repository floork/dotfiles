#!/bin/env bash

function update_dotfiles() {
	if ! [[ $(git status --porcelain) ]]; then
		echo "Pulling latest updates..."
		git pull
		return
	fi

	echo "Stashing any changes..."

	# Stash any changes
	git stash --include-untracked --quiet

	# Update the repository
	git pull

	# Pop the stash
	git stash pop --quiet
}

function update_nvim() {
	NVIM_CONFIG_DIR="$HOME/.config/nvim"
	echo "Updating nvim configuration..."
	if ! [[ -d "$NVIM_CONFIG_DIR" ]]; then
		git clone https://github.com/floork/nvim.git "$NVIM_CONFIG_DIR" || {
			echo "Failed to clone nvim configuration"
			exit 1
		}
		return
	fi

	cd "$NVIM_CONFIG_DIR" || exit
	git pull || {
		echo "Failed to update nvim configuration"
		exit 1
	}
	cd "$script_dir" || exit
}

function update_user_bin_directory() {
	BIN_DIR="$HOME/.local/bin"
	mkdir -p "$BIN_DIR"

	for file in "$script_dir/bin"/*; do
		ln -sf "$file" "$BIN_DIR/" || {
			echo "Failed to update user bin directory"
			exit 1
		}
	done
}

function run_installation_script() {
	# Run the installation script
	bash "$HOME/dotfiles/install.sh"
}

function main() {
	local current_dir
	local desired_dir

	# Get the current directory
	current_dir=$(pwd)

	# Change to the dotfiles directory
	desired_dir="$HOME/dotfiles/"
	cd "$desired_dir" || exit

	# Update the repository
	update_dotfiles
	update_nvim
	update_user_bin_directory
	run_installation_script

	# Return to the original directory
	cd "$current_dir" || exit
}

main
