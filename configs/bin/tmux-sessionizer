#!/usr/bin/env bash

# inspired by https://github.com/ThePrimeagen/tmux-sessionizer
# but with some changes to fit my workflows

# Configurable variables
EXCLUDES=(".git" "node_modules" "Downloads")
SEARCH_PATHS=("$HOME")

find_directories() {
  local exclude_args=()
  for exclude in "${EXCLUDES[@]}"; do
    exclude_args+=("-E" "$exclude")
  done

  local directories=""
  for path in "${SEARCH_PATHS[@]}"; do
    directories+="$(fd -t d "${exclude_args[@]}" --base-directory "$path")"$'\n'
  done

  # Add search paths themselves
  for path in "${SEARCH_PATHS[@]}"; do
    directories+="$path"$'\n'
  done

  echo "$directories" | awk 'NF' | sort -u
}

switch_to_tmux_session() {
  if [[ -z $TMUX ]]; then
    tmux attach-session -t "$1"
  else
    tmux switch-client -t "$1"
  fi
}

tmux_session_exists() {
  tmux list-sessions -F '#{session_name}' | grep -qx "$1"
}

source_tmux_sessionizer() {
  local session_name="$1"
  local directory="$2"

  local sessionizer_file="$directory/.tmux-sessionizer"
  local home_sessionizer="$HOME/.tmux-sessionizer"

  if [ -f "$sessionizer_file" ]; then
    tmux send-keys -t "$session_name" "source $sessionizer_file" C-m
  elif [ -f "$home_sessionizer" ]; then
    tmux send-keys -t "$session_name" "source $home_sessionizer" C-m
  fi
}

select_directory_with_fzf() {
  find_directories | fzf
}

create_and_attach_session() {
  local session_name="$1"
  local directory="$2"

  tmux new-session -ds "$session_name" -c "$directory"
  source_tmux_sessionizer "$session_name" "$directory"
  switch_to_tmux_session "$session_name"
}

generate_session_name() {
  local path="$1"

  if [[ -z $path || ! -d $path ]]; then
    echo "invalid_session"
    return
  fi

  path=$(realpath "$path" 2>/dev/null)
  [[ -z $path ]] && echo "invalid_session" && return

  IFS='/' read -ra parts <<<"$path"
  local count=${#parts[@]}

  if ((count >= 2)); then
    local part1="${parts[count - 2]}"
    local part2="${parts[count - 1]}"
    # Sanitize: replace `.` with `_`
    part1="${part1//./_}"
    part2="${part2//./_}"
    echo "${part1}_${part2}"
  else
    echo "$(basename "$path" | tr '.' '_')"
  fi
}

main() {
  local selected="$1"

  if [[ -z $selected ]]; then
    selected=$(select_directory_with_fzf)
  fi

  [[ -z $selected ]] && exit 0

  selected=$(realpath "$selected" 2>/dev/null) || {
    echo "Error: Could not resolve path '$selected'" >&2
    exit 1
  }

  local session_name
  session_name=$(generate_session_name "$selected")

  if ! tmux_session_exists "$session_name"; then
    create_and_attach_session "$session_name" "$selected"
  else
    switch_to_tmux_session "$session_name"
  fi
}

main "$@"
